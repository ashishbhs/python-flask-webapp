import fitz  # PyMuPDF
import pdfplumber
import pytesseract
from PIL import Image
import re
import io
import os

def extract_text_kv(pdf_path):
    doc = fitz.open(pdf_path)
    kv_pairs = []
    for page in doc:
        text = page.get_text()
        pairs = re.findall(r'([\w\s]+?)\s*:\s*([\w\s]+)', text)
        kv_pairs.extend([(k.strip(), v.strip()) for k, v in pairs])
    return kv_pairs

def extract_table_kv(pdf_path):
    kv_pairs = []
    with pdfplumber.open(pdf_path) as pdf:
        for page in pdf.pages:
            tables = page.extract_tables()
            for table in tables:
                for row in table:
                    if len(row) == 2 and row[0] and row[1]:
                        kv_pairs.append((row[0].strip(), row[1].strip()))
    return kv_pairs

def extract_ocr_kv_with_pymupdf(pdf_path):
    doc = fitz.open(pdf_path)
    kv_pairs = []
    for page in doc:
        pix = page.get_pixmap(dpi=300)  # render page as image at high resolution
        image = Image.open(io.BytesIO(pix.tobytes("png")))
        text = pytesseract.image_to_string(image)
        pairs = re.findall(r'([\w\s]+?)\s*:\s*([\w\s]+)', text)
        kv_pairs.extend([(k.strip(), v.strip()) for k, v in pairs])
    return kv_pairs

def extract_all(pdf_path):
    print(f"üìÑ Processing PDF: {pdf_path}")

    text_kv = extract_text_kv(pdf_path)
    print(f"‚úÖ Text-based key-value pairs: {len(text_kv)}")

    table_kv = extract_table_kv(pdf_path)
    print(f"‚úÖ Table key-value pairs: {len(table_kv)}")

    ocr_kv = extract_ocr_kv_with_pymupdf(pdf_path)
    print(f"‚úÖ OCR-based key-value pairs (without Poppler): {len(ocr_kv)}")

    # Merge all and remove duplicates
    all_kv = list({(k, v) for k, v in (text_kv + table_kv + ocr_kv)})
    print(f"üìä Total unique key-value pairs: {len(all_kv)}\n")

    for key, value in all_kv:
        print(f"{key} -> {value}")

    return all_kv

if __name__ == "__main__":
    pdf_file = "your_form.pdf"
    if os.path.exists(pdf_file):
        extract_all(pdf_file)
    else:
        print("‚ùå PDF file not found. Update the 'pdf_file' path.")
